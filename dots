#!/bin/bash

# Dotfiles CLI — unified interface for all dotfiles operations
# Usage: dots <command> [args]

set -e

# Resolve real path even when called through symlink
SCRIPT_PATH="$0"
if [[ -L "$SCRIPT_PATH" ]]; then
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
fi
DOTFILES="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# ============================================================
# Helpers
# ============================================================
info()    { printf "\033[34m→\033[0m %s\n" "$1"; }
error()   { printf "\033[31m✗\033[0m %s\n" "$1"; }

show_help() {
  cat <<EOF
$(printf "\033[1;36mdots\033[0m") — dotfiles management CLI

$(printf "\033[1mUsage:\033[0m") dots <command> [args]

$(printf "\033[1mMain commands:\033[0m")
  $(printf "\033[36msetup\033[0m | \033[36minit\033[0m") [--work|--personal]   Full system setup (new Mac bootstrap)
  $(printf "\033[36msave\033[0m | \033[36mupdate\033[0m")                      Save current state to repo
  $(printf "\033[36mrun\033[0m") <script> [args]                Run individual setup script

$(printf "\033[1mAvailable scripts\033[0m") (dots run <script>):
  brew [profile]              Install Homebrew packages
  symlinks [profile]          Create config symlinks
  dock [profile]              Apply Dock layout
  claude [-y]                 Setup Claude Code configs
  macos                       Apply macOS system defaults
  curl                        Install curl-based tools

$(printf "\033[1mExamples:\033[0m")
  dots setup --work           # bootstrap new work Mac
  dots save                   # snapshot current state
  dots run brew               # re-run brew install (uses saved profile)
  dots run dock work          # apply work dock layout
  dots run claude             # setup Claude (interactive prompts)

$(printf "\033[2mNote:\033[0m") Scripts read profile from ~/.dotfiles-profile when not specified.
EOF
}

# ============================================================
# Command dispatcher
# ============================================================
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
  setup|init)
    exec "$DOTFILES/setup.sh" "$@"
    ;;
  save|update)
    exec "$DOTFILES/save.sh" "$@"
    ;;
  run)
    SCRIPT="${1:-}"
    shift || true
    case "$SCRIPT" in
      brew)
        exec "$DOTFILES/scripts/brew-install.sh" "$@"
        ;;
      symlinks)
        exec "$DOTFILES/scripts/symlinks.sh" "$@"
        ;;
      dock)
        exec "$DOTFILES/scripts/dock-apply.sh" "$@"
        ;;
      claude)
        exec "$DOTFILES/scripts/claude-setup.sh" "$@"
        ;;
      macos)
        exec "$DOTFILES/scripts/macos-defaults.sh" "$@"
        ;;
      curl)
        exec "$DOTFILES/scripts/curl-tools.sh" "$@"
        ;;
      "")
        error "Missing script name"
        echo ""
        show_help
        exit 1
        ;;
      *)
        error "Unknown script: $SCRIPT"
        echo ""
        show_help
        exit 1
        ;;
    esac
    ;;
  help|--help|-h|"")
    show_help
    exit 0
    ;;
  *)
    error "Unknown command: $COMMAND"
    echo ""
    show_help
    exit 1
    ;;
esac

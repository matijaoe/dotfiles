#!/bin/bash

# Dotfiles CLI — unified interface for all dotfiles operations
# Usage: dots <command> [args]

set -euo pipefail

# Resolve real path even when called through symlink
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
DOTFILES="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# ============================================================
# Helpers
# ============================================================
info()    { printf "\033[34m→\033[0m %s\n" "$1"; }
error()   { printf "\033[31m✗\033[0m %s\n" "$1"; }

show_help() {
  local RESET=$'\033[0m'
  local BOLD=$'\033[1m'
  local DIM=$'\033[2m'
  local CYAN=$'\033[36m'
  local YELLOW=$'\033[33m'
  local COL_W=40

  row() {
    local plain="$1"
    local styled="$2"
    local desc="$3"
    local pad=$((COL_W - ${#plain}))
    (( pad < 1 )) && pad=1
    printf "  %s%*s%s%s%s\n" "$styled" "$pad" "" "$DIM" "$desc" "$RESET"
  }

  printf "\n%b" "$CYAN"
  cat <<'EOF'
_________/\\\___________________________________________
 ________\/\\\___________________________________________
  ________\/\\\____________________/\\\___________________
   ________\/\\\______/\\\\\_____/\\\\\\\\\\\__/\\\\\\\\\\_
    ___/\\\\\\\\\____/\\\///\\\__\////\\\////__\/\\\//////__
     __/\\\////\\\___/\\\__\//\\\____\/\\\______\/\\\\\\\\\\_
      _\/\\\__\/\\\__\//\\\__/\\\_____\/\\\_/\\__\////////\\\_
       _\//\\\\\\\/\\__\///\\\\\/______\//\\\\\____/\\\\\\\\\\_
        __\///////\//_____\/////_________\/////____\//////////__
EOF
  printf "%b\n" "$RESET"

  printf "%b%s%b %s%s%b\n\n" "$BOLD" "dots" "$RESET" "$DIM" "dotfiles management CLI" "$RESET"

  printf "%b%s%b\n" "$BOLD" "USAGE" "$RESET"
  printf "  %bdots%b <command> [options]\n\n" "$CYAN" "$RESET"

  printf "%b%s%b\n" "$BOLD" "COMMANDS" "$RESET"
  row "setup, init [--work|--personal]"  "${CYAN}setup${RESET}, ${CYAN}init${RESET} [${YELLOW}--work${RESET}|${YELLOW}--personal${RESET}]"  "Bootstrap or re-run full setup"
  row "save, update"                     "${CYAN}save${RESET}, ${CYAN}update${RESET}"                     "Save current machine state to repo"
  row "run <script> [profile]"            "${CYAN}run${RESET} <script> [profile]"                               "Run a single script"
  row "help"                             "${CYAN}help${RESET}"                                           "Show this help"
  printf "\n"

  printf "%b%s%b\n" "$BOLD" "SCRIPTS" "$RESET"
  row "brew"      "${CYAN}brew${RESET}"      "Install Homebrew packages"
  row "symlinks"  "${CYAN}symlinks${RESET}"  "Create config symlinks"
  row "dock"      "${CYAN}dock${RESET}"      "Apply Dock layout"
  row "macos"     "${CYAN}macos${RESET}"     "Apply macOS defaults"
  row "claude"    "${CYAN}claude${RESET}"    "Setup Claude Code configs"
  row "curl"      "${CYAN}curl${RESET}"      "Install curl-based tools"
  printf "\n"

  printf "%b%s%b\n" "$BOLD" "PROFILES" "$RESET"
  printf "  %bpersonal%b, %bwork%b\n\n" "$YELLOW" "$RESET" "$YELLOW" "$RESET"
  printf "  Resolved in order:\n"
  row "1. Flag"    "1. Flag"    "--work or --personal"
  row "2. Saved"   "2. Saved"   "~/.dotfiles-profile"
  row "3. Prompt"  "3. Prompt"  "asked during setup"
  printf "\n"

  printf "%b%s%b\n" "$BOLD" "EXAMPLES" "$RESET"
  row "dots setup --work"    "${CYAN}dots setup --work${RESET}"    "# bootstrap new work Mac"
  row "dots save"            "${CYAN}dots save${RESET}"            "# snapshot current state"
  row "dots run brew"        "${CYAN}dots run brew${RESET}"        "# install Homebrew packages"
  row "dots run symlinks"    "${CYAN}dots run symlinks${RESET}"    "# create config symlinks"
  row "dots run dock --work" "${CYAN}dots run dock --work${RESET}" "# apply work Dock layout"
  row "dots run macos"       "${CYAN}dots run macos${RESET}"       "# apply macOS defaults"
  row "dots run claude"      "${CYAN}dots run claude${RESET}"      "# setup Claude Code configs"
  row "dots run curl"        "${CYAN}dots run curl${RESET}"        "# install curl-based tools"
  printf "\n"
}

# ============================================================
# Command dispatcher
# ============================================================
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
  setup|init)
    exec "$DOTFILES/setup.sh" "$@"
    ;;
  save|update)
    exec "$DOTFILES/save.sh" "$@"
    ;;
  run)
    SCRIPT="${1:-}"
    shift || true
    case "$SCRIPT" in
      brew)
        exec "$DOTFILES/scripts/brew-install.sh" "$@"
        ;;
      symlinks)
        exec "$DOTFILES/scripts/symlinks.sh" "$@"
        ;;
      dock)
        exec "$DOTFILES/scripts/dock-apply.sh" "$@"
        ;;
      claude)
        exec "$DOTFILES/scripts/claude-setup.sh" "$@"
        ;;
      macos)
        exec "$DOTFILES/scripts/macos-defaults.sh" "$@"
        ;;
      curl)
        exec "$DOTFILES/scripts/curl-tools.sh" "$@"
        ;;
      "")
        error "Missing script name"
        echo ""
        show_help
        exit 1
        ;;
      *)
        error "Unknown script: $SCRIPT"
        echo ""
        show_help
        exit 1
        ;;
    esac
    ;;
  help|--help|-h|"")
    show_help
    exit 0
    ;;
  *)
    error "Unknown command: $COMMAND"
    echo ""
    show_help
    exit 1
    ;;
esac

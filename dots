#!/bin/bash

# Dotfiles CLI — unified interface for all dotfiles operations
# Usage: dots <command> [args]

set -euo pipefail

# Resolve real path even when called through symlink
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
DOTFILES="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# ============================================================
# Helpers
# ============================================================
info()    { printf "\033[34m→\033[0m %s\n" "$1"; }
error()   { printf "\033[31m✗\033[0m %s\n" "$1"; }

show_help() {
  if command -v gum &>/dev/null; then
    _show_help_gum
  else
    _show_help_plain
  fi
}

_show_help_gum() {
  local banner
  banner=$(cat <<'BANNER'
_________/\\\___________________________________________
 ________\/\\\___________________________________________
  ________\/\\\____________________/\\\___________________
   ________\/\\\______/\\\\\_____/\\\\\\\\\\\__/\\\\\\\\\\_
    ___/\\\\\\\\\____/\\\///\\\__\////\\\////__\/\\\//////__
     __/\\\////\\\___/\\\__\//\\\____\/\\\______\/\\\\\\\\\\_
      _\/\\\__\/\\\__\//\\\__/\\\_____\/\\\_/\\__\////////\\\_
       _\//\\\\\\\/\\__\///\\\\\/______\//\\\\\____/\\\\\\\\\\_
        __\///////\//_____\/////_________\/////____\//////////__
BANNER
  )
  echo ""
  gum style --foreground 6 "$banner"
  echo ""

  gum format <<'HELP'
**dots** — *dotfiles management CLI*

## Usage

`dots <command> [options]`

## Commands

| Command | Description |
|---|---|
| **setup**, **init** [--work\|--personal] | Bootstrap or re-run full setup |
| **save**, **update** | Save current machine state to repo |
| **run** \<script\> [profile] | Run a single script |
| **help** | Show this help |

## Scripts

| Script | Description |
|---|---|
| **brew** | Install Homebrew packages |
| **symlinks** | Create config symlinks |
| **dock** | Apply Dock layout |
| **macos** | Apply macOS defaults |
| **claude** | Setup Claude Code configs |
| **cursor** | Restore Cursor settings and keybindings |
| **curl** | Install curl-based tools |

## Profiles

**personal**, **work**

Resolved in order:
1. Flag — `--work` or `--personal`
2. Saved — `~/.dotfiles-profile`
3. Prompt — asked during setup

## Examples
HELP

  # Render examples with dim gray comments
  local examples=(
    "dots setup --work      |# bootstrap new work Mac"
    "dots save              |# snapshot current state"
    "dots run brew          |# install Homebrew packages"
    "dots run symlinks      |# create config symlinks"
    "dots run dock --work   |# apply work Dock layout"
    "dots run macos         |# apply macOS defaults"
    "dots run claude        |# setup Claude Code configs"
    "dots run cursor        |# restore Cursor settings"
    "dots run curl          |# install curl-based tools"
  )
  for line in "${examples[@]}"; do
    local cmd="${line%%|*}"
    local comment="${line#*|}"
    printf "  %s \033[2m%s\033[0m\n" "$cmd" "$comment"
  done
  echo ""
}

_show_help_plain() {
  cat <<'EOF'

dots — dotfiles management CLI

Usage: dots <command> [options]

Commands:
  setup, init [--work|--personal]  Bootstrap or re-run full setup
  save, update                     Save current machine state to repo
  run <script> [profile]           Run a single script
  help                             Show this help

Scripts:
  brew       Install Homebrew packages
  symlinks   Create config symlinks
  dock       Apply Dock layout
  macos      Apply macOS defaults
  claude     Setup Claude Code configs
  cursor     Restore Cursor settings and keybindings
  curl       Install curl-based tools

Profiles: personal, work
  Resolved: 1. Flag  2. ~/.dotfiles-profile  3. Prompt

Examples:
  dots setup --work       # bootstrap new work Mac
  dots save               # snapshot current state
  dots run brew           # install Homebrew packages
  dots run symlinks       # create config symlinks
  dots run dock --work    # apply work Dock layout
  dots run macos          # apply macOS defaults
  dots run claude         # setup Claude Code configs
  dots run cursor         # restore Cursor settings
  dots run curl           # install curl-based tools

EOF
}

# ============================================================
# Command dispatcher
# ============================================================
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
  setup|init)
    exec "$DOTFILES/setup.sh" "$@"
    ;;
  save|update)
    exec "$DOTFILES/save.sh" "$@"
    ;;
  run)
    SCRIPT="${1:-}"
    shift || true
    case "$SCRIPT" in
      brew)
        exec "$DOTFILES/scripts/brew-install.sh" "$@"
        ;;
      symlinks)
        exec "$DOTFILES/scripts/symlinks.sh" "$@"
        ;;
      dock)
        exec "$DOTFILES/scripts/dock-apply.sh" "$@"
        ;;
      claude)
        exec "$DOTFILES/scripts/claude-setup.sh" "$@"
        ;;
      cursor)
        exec "$DOTFILES/scripts/cursor-setup.sh" "$@"
        ;;
      macos)
        source "$DOTFILES/scripts/lib/common.sh"
        section "macOS defaults"
        gum spin --spinner dot --title "Applying macOS defaults..." -- \
          bash "$DOTFILES/scripts/macos-defaults.sh"
        success "Applied — some changes require restart"
        exit 0
        ;;
      curl)
        exec "$DOTFILES/scripts/curl-tools.sh" "$@"
        ;;
      "")
        error "Missing script name"
        echo ""
        show_help
        exit 1
        ;;
      *)
        error "Unknown script: $SCRIPT"
        echo ""
        show_help
        exit 1
        ;;
    esac
    ;;
  help|--help|-h|"")
    show_help
    exit 0
    ;;
  *)
    error "Unknown command: $COMMAND"
    echo ""
    show_help
    exit 1
    ;;
esac

#!/bin/bash

# Dotfiles CLI — unified interface for all dotfiles operations
# Usage: dots <command> [args]

set -euo pipefail

# Resolve real path even when called through symlink
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [[ -L "$SCRIPT_PATH" ]]; do
  SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
  SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
  [[ "$SCRIPT_PATH" != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
DOTFILES="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"

# ============================================================
# Helpers
# ============================================================
info()    { printf "\033[34m→\033[0m %s\n" "$1"; }
error()   { printf "\033[31m✗\033[0m %s\n" "$1"; }

show_help() {
  local RESET=$'\033[0m'
  local BOLD=$'\033[1m'
  local DIM=$'\033[2m'
  local CYAN=$'\033[36m'
  local YELLOW=$'\033[33m'
  local COL_W=40
  local EX_W=28

  row() {
    local plain="$1"
    local styled="$2"
    local desc="$3"
    local pad=$((COL_W - ${#plain}))
    (( pad < 1 )) && pad=1
    printf "  %s%*s%s%s%s\n" "$styled" "$pad" "" "$DIM" "$desc" "$RESET"
  }

  printf "\n%b" "$CYAN"
  cat <<'EOF'
_________/\\\___________________________________________
 ________\/\\\___________________________________________
  ________\/\\\____________________/\\\___________________
   ________\/\\\______/\\\\\_____/\\\\\\\\\\\__/\\\\\\\\\\_
    ___/\\\\\\\\\____/\\\///\\\__\////\\\////__\/\\\//////__
     __/\\\////\\\___/\\\__\//\\\____\/\\\______\/\\\\\\\\\\_
      _\/\\\__\/\\\__\//\\\__/\\\_____\/\\\_/\\__\////////\\\_
       _\//\\\\\\\/\\__\///\\\\\/______\//\\\\\____/\\\\\\\\\\_
        __\///////\//_____\/////_________\/////____\//////////__
EOF
  printf "%b\n" "$RESET"

  printf "%b%s%b %s%s%b\n\n" "$BOLD" "dots" "$RESET" "$DIM" "dotfiles management CLI" "$RESET"

  printf "%b%s%b\n" "$BOLD" "USAGE" "$RESET"
  printf "  %bdots%b <command> [options]\n\n" "$CYAN" "$RESET"

  printf "%b%s%b\n" "$BOLD" "COMMANDS" "$RESET"
  row "setup, init [--work|--personal]"  "${CYAN}setup${RESET}, ${CYAN}init${RESET} [${YELLOW}--work${RESET}|${YELLOW}--personal${RESET}]"  "Bootstrap or re-run full setup"
  row "save, update"                     "${CYAN}save${RESET}, ${CYAN}update${RESET}"                     "Save current machine state to repo"
  row "run <script> [profile]"            "${CYAN}run${RESET} <script> [profile]"                               "Run a single script"
  row "help"                             "${CYAN}help${RESET}"                                           "Show this help"
  printf "\n"

  printf "%b%s%b\n" "$BOLD" "SCRIPTS" "$RESET"
  row "brew"      "${CYAN}brew${RESET}"      "Install Homebrew packages"
  row "symlinks"  "${CYAN}symlinks${RESET}"  "Create config symlinks"
  row "dock"      "${CYAN}dock${RESET}"      "Apply Dock layout"
  row "macos"     "${CYAN}macos${RESET}"     "Apply macOS defaults"
  row "claude"    "${CYAN}claude${RESET}"    "Setup Claude Code configs"
  row "curl"      "${CYAN}curl${RESET}"      "Install curl-based tools"
  printf "\n"

  printf "%b%s%b\n" "$BOLD" "PROFILES" "$RESET"
  printf "  %bpersonal%b, %bwork%b\n" "$YELLOW" "$RESET" "$YELLOW" "$RESET"
  printf "  Resolved in order:\n"
  printf "    1. Flag        %b--work%b or %b--personal%b\n" "$YELLOW" "$RESET" "$YELLOW" "$RESET"
  printf "    2. Saved       %b~/.dotfiles-profile%b\n" "$CYAN" "$RESET"
  printf "    3. Prompt      %basked during setup%b\n\n" "$DIM" "$RESET"

  printf "%b%s%b\n" "$BOLD" "EXAMPLES" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots setup --work" "$RESET" "$DIM" "bootstrap new work Mac" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots save" "$RESET" "$DIM" "snapshot current state" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run brew" "$RESET" "$DIM" "install Homebrew packages" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run symlinks" "$RESET" "$DIM" "create config symlinks" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run dock --work" "$RESET" "$DIM" "apply work Dock layout" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run macos" "$RESET" "$DIM" "apply macOS defaults" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run claude" "$RESET" "$DIM" "setup Claude Code configs" "$RESET"
  printf "  %b%-${EX_W}s%b %b# %s%b\n" "$CYAN" "dots run curl" "$RESET" "$DIM" "install curl-based tools" "$RESET"
  printf "\n"
}

# ============================================================
# Command dispatcher
# ============================================================
COMMAND="${1:-}"
shift || true

case "$COMMAND" in
  setup|init)
    exec "$DOTFILES/setup.sh" "$@"
    ;;
  save|update)
    exec "$DOTFILES/save.sh" "$@"
    ;;
  run)
    SCRIPT="${1:-}"
    shift || true
    case "$SCRIPT" in
      brew)
        exec "$DOTFILES/scripts/brew-install.sh" "$@"
        ;;
      symlinks)
        exec "$DOTFILES/scripts/symlinks.sh" "$@"
        ;;
      dock)
        exec "$DOTFILES/scripts/dock-apply.sh" "$@"
        ;;
      claude)
        exec "$DOTFILES/scripts/claude-setup.sh" "$@"
        ;;
      macos)
        exec "$DOTFILES/scripts/macos-defaults.sh" "$@"
        ;;
      curl)
        exec "$DOTFILES/scripts/curl-tools.sh" "$@"
        ;;
      "")
        error "Missing script name"
        echo ""
        show_help
        exit 1
        ;;
      *)
        error "Unknown script: $SCRIPT"
        echo ""
        show_help
        exit 1
        ;;
    esac
    ;;
  help|--help|-h|"")
    show_help
    exit 0
    ;;
  *)
    error "Unknown command: $COMMAND"
    echo ""
    show_help
    exit 1
    ;;
esac
